<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>OpenAI Prompt Page</title>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">

<style>
  body {
    font-family: Arial, sans-serif;
    margin: 20px;
  }
  .login-container, .input-container, .output-container {
    margin-bottom: 20px;
  }
  textarea {
    width: 100%;
    height: 200px;
    font-size: 16px;
    padding: 10px;
    box-sizing: border-box;
    resize: none;
  }
  button {
    margin-top: 10px;
    padding: 10px 20px;
    font-size: 16px;
  }
  .output-container {
    margin-top: 40px;
    border-top: 1px solid #ccc;
    padding-top: 20px;
    min-height: 100px;
  }
</style>
</head>
<body>
<div class="login-container" id="loginContainer">
  <h2>Sign In with Google</h2>
  <a href="/login"><button id="loginButton">Login with Google</button></a>
  <p id="loginStatus"></p>
</div>

<div class="input-container" id="inputContainer" style="display: none;">
  <h2>Enter Your Story for Analysis</h2>
  <textarea id="promptInput" placeholder="Paste your story here..."></textarea><br/>
  <button id="sendButton">Send</button>
</div>

<div class="output-container" id="outputContainer" style="display: none;">
  <h2>Output</h2>
</div>

<script>
async function checkLoginStatus() {
  // Attempt a simple call to /api/ask_static with no prompt just to check if logged in
  // Alternatively, create a separate endpoint to verify login if desired
  const response = await fetch("/api/ask_static", {method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({})});
  if (response.status === 401) {
    // not logged in
    $("#loginContainer").show();
    $("#inputContainer").hide();
    $("#outputContainer").hide();
  } else {
    // logged in
    $("#loginContainer").hide();
    $("#inputContainer").show();
    $("#outputContainer").show();
  }
}

$("#sendButton").on("click", async function() {
  const userPrompt = $("#promptInput").val().trim();
  if (!userPrompt) {
    alert("Please enter a prompt.");
    return;
  }

  const response = await fetch("/api/ask_static", {
    method: "POST",
    headers: {
      "Content-Type": "application/json"
    },
    body: JSON.stringify({ story: userPrompt })
  });

  const data = await response.json();
  if (response.ok) {
    $("#outputContainer").empty(); // Clear previous output
    const container = $("<div>").addClass("container");

    $.each(data.analysis, function(index, label) {
      const row = $("<div>").addClass("row mb-3");

      const labelCol = $("<div>").addClass("col-md-3").text(label);
      const sentenceCol = $("<div>").addClass("col-md-9").text(data.sentences[index]);
      const colorMap = {
        "Headline": "#1f77b4",
        "Introduction": "#ff7f0e",
        "Lede": "#2ca02c",
        "Nut graf": "#d62728",
        "Background information": "#9467bd",
        "Opinion": "#8c564b",
        "Color": "#e377c2",
        "Transition": "#7f7f7f",
        "Supporting detail": "#bcbd22",
        "Sourcing/source information": "#17becf"
      };

      const labelColor = colorMap[label] || "#ffffff"; // Default to white if label not found
      labelCol.css("background-color", labelColor);
      row.append(labelCol, sentenceCol);
      container.append(row);
    });

    $("#outputContainer").append(container);
  } else {
    displayOutput("Error: " + (data.message || data.error));
  }
});

function displayOutput(text) {
  const p = $("<p>").text(text);
  $("#outputContainer").append(p);
}

checkLoginStatus();
</script>

</body>
</html>
